# PATCHLOG 2026-01-06: AI Prompts 模組化與英文化 + 專案分析器增強

## 目標

### Part 1: AI Prompt 模組化

1. **AI 背景指令英文化**: 將所有發送給 AI 的 system prompts 改為英文撰寫，以獲得更穩定的 AI 回應品質
2. **輸出語言遵從用戶設定**: 在每個 prompt 中指示 AI 必須使用用戶在設定介面選擇的語言回覆
3. **Prompt 模組化**: 將分散在各處的 AI 指令集中管理，便於未來維護與修改

### Part 2: 專案分析器增強

4. **結構化 AI 分析回應**: AI 分析後回傳結構化 JSON，包含 spec、agents、diagrams
5. **一鍵分發功能**: 將分析結果分發到專案說明書、團隊設定、Workflow Visualizer

---

## 修改摘要

### 新增檔案

- [x] `src/utils/ai-prompts.ts` - 集中式 AI Prompts 模組
  - `getChatWindowSystemPrompt(language)` - Chat Window 系統指令
  - `getProjectSetupSystemPrompt(language)` - 專案設定系統指令
  - `getSpecReviewSystemPrompt(language)` - 規格審查系統指令
  - `getTaskInjectionSystemPrompt(language)` - 任務注入系統指令
  - `getProjectAnalyzerSystemPrompt(language)` - **新增** 專案分析器系統指令
  - `getCurrentOutputLanguage()` - 取得當前用戶語言設定

### 修改檔案

- [x] `src/utils/projectConfig.ts`

  - 刪除原有的 `getProjectSetupSystemPrompt()` 函式 (約 250 行)
  - 改為從 `ai-prompts.ts` 重新匯出 (保持向後相容性)
  - 擴展 `Language` 類型支援更多語言

- [x] `src/App.tsx`

  - 匯入 `getTaskInjectionSystemPrompt` 和 `getCurrentOutputLanguage`
  - 將硬編碼的中文 system prompt 改用模組化函式

- [x] `src/components/features/SpecPage.tsx`

  - 匯入 `getSpecReviewSystemPrompt`
  - 將 AI Review 功能的 system prompt 改用模組化函式
  - User prompt 也改為英文（AI 會根據 language 設定回覆）

- [x] `src/components/features/AiChatWindow.tsx`

  - 匯入 `getChatWindowSystemPrompt`
  - 初始 systemPrompt 改用模組化函式
  - Reset 功能改用模組化函式 (帶入當前 outputLanguage)
  - 語言變更時自動更新 systemPrompt

- [x] `src/components/features/ProjectAnalyzer.tsx` - **重構**

  - 新增 `AnalyzedProject` 介面定義結構化分析結果
  - 重寫 `handleGenerateDocs()` 使用結構化 prompt
  - 新增 `handleDistributeToTeam()` - 分發 Agents 到團隊設定
  - 新增 `handleDistributeToDiagrams()` - 分發流程圖到 Planner
  - 新增 `handleDistributeAll()` - 一鍵全部分發
  - 添加分發按鈕 UI

- [x] `src/components/features/Planner.tsx`
  - 添加 `diagrams-distributed` 事件監聽器
  - 接收分發的流程圖並更新顯示

---

## 設計原則

### AI Prompt 語言分離架構

```
┌─────────────────────────────────────────────────────────────┐
│                      用戶語言選擇                             │
│                    (Settings Page)                           │
│                         ↓                                    │
│              localStorage: taskrails_lang                    │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    ai-prompts.ts                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ **OUTPUT LANGUAGE DIRECTIVE (MANDATORY):**           │   │
│  │ You MUST respond in [User's Language].               │   │
│  └──────────────────────────────────────────────────────┘   │
│                         +                                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ [ENGLISH INSTRUCTIONS FOR AI]                        │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 專案分析器分發流程

```
┌───────────────────────┐
│   ProjectAnalyzer     │
│   ┌───────────────┐   │
│   │ AI 生成       │   │
│   └───────────────┘   │
│           ↓           │
│   ┌───────────────┐   │
│   │ analyzedProject│   │
│   │ - spec        │   │
│   │ - agents      │   │
│   │ - diagrams    │   │
│   └───────────────┘   │
└───────────────────────┘
         ↓  emit()
    ┌────┴────┬──────────┐
    ↓         ↓          ↓
┌───────┐ ┌───────┐ ┌─────────┐
│SpecPage│ │RoleSettings│ │ Planner │
│(說明書)│ │ (團隊設定) │ │ (流程圖) │
└───────┘ └───────┘ └─────────┘
```

---

## 驗證

- [x] TypeScript 編譯成功 (`npx tsc --noEmit` 無錯誤)
- [ ] 功能測試：專案分析器 AI 生成結構化結果
- [ ] 功能測試：一鍵分發到各頁面
- [ ] 功能測試：切換語言設定後 AI 回覆語言是否正確切換

---

## 防劣化證明

- 所有現有功能使用相同的函數簽名
- 未刪除任何用戶可見功能
