# PATCHLOG - 2025-12-23

## 1. 目標 (Target)

完成多國語系 (i18n) 全面覆蓋、後端 AI 架構重構與 **設定同步性修復**。此外，修復 **Google Gemini** 模型支援問題。

## 2. 防劣化證明 (Anti-Degradation Proof)

- **前端**：確保所有語系檔 (`zh-TW`, `zh-CN`, `en-US` 等) 均嚴格遵循 `TranslationType` 介面，避免運行時因找不到鍵值而崩潰。
- **後端**：重構 `execute_ai_chat` 邏輯，將具體 API 實作抽離至 `AiClient`。
  - **Anthropic**: 使用原生 Headers 與 JSON 結構。
  - **Google**: 從 OpenAI 兼容層遷移至 **原生 REST API (`v1beta:generateContent`)**，徹底解決 OpenAI Shim 對新模型支援度不佳的問題。
- **資料一致性**：引入 `constants/ai-models.ts` 統一管理 AI 模型列表，並確保 Settings 切換 Provider 時會自動重置無效的模型名稱。

## 3. 變更摘要 (Change Summary)

### Frontend (i18n & Logic)

- **SettingsPage.tsx**:
  - 新增邏輯：當 Provider 改變時，自動將 Model 重置為該 Provider 的第一個預設模型，防止送出錯誤的模型名稱。
  - 使用 `PROVIDER_MODELS` 常數。
- **SpecPage.tsx**:
  - **修復設定同步問題**：將 `useEffect` 依賴改為 `[showChat]`，確保每次打開對話視窗時都會從後端重新讀取最新的 AI Provider/Model 設定。
- **constants/ai-models.ts**: 更新 Google 模型列表，修正模型名稱為官方文件支援的穩定版本（如 `gemini-2.5-flash`）。

### Backend (Rust)

- **utils/ai.rs**:
  - 新增 `GoogleRequest`, `GoogleContent` 等結構（使用 `serde` rename 支援 camelCase API 欄位）。
  - 實作 `execute_google` 方法，直接調用 Google 原生 API，支援 System Instructions 與多輪對話。

## 4. 執行 TodoList

### Phase 1: i18n Fixes (Completed)

- [x] 修復 `zh-TW.ts` 的語法與結構錯誤。
- [x] 同步更新所有語系檔。

### Phase 2: Backend Refactor (Completed)

- [x] 創建 `utils/ai.rs`。
- [x] 重寫 `commands.rs`。
- [x] **[NEW] 實作 Google Native API 用戶端**以解決模型 404 問題。
- [x] **[NEW] 修正 Rust 變數命名規範**（snake_case）。

### Phase 3: AI Configuration Sync (Completed)

- [x] 建立 `src/constants/ai-models.ts`，並更新為穩定版模型。
- [x] 修復 SettingsPage 模型自動重置邏輯。
- [x] 修復 SpecPage 設定讀取時機。

### Phase 4: Validation

- [x] 靜態代碼檢查。
- [x] 確認 Rust 代碼符合 Clippy 規範 (CamelCase JSON 序列化)。
- [ ] 用戶測試：Google Gemini 2.5/Flash 是否能正常回應。
