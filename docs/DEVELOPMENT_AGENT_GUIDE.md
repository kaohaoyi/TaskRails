# TaskRails 代理人與持久化開發指南 (v1.1)

本文件說明 TaskRails 如何實現 AIIDE 控制台的對話持久化，以及 AGENT 的建立標準。

## 1. 對話持久化機制 (Preservation)

為了確保使用者在切換視窗（如從 Planner 到 AIIDE）或重啟應用後不會遺失對話，我們採用了 **SQLite 持久化方案**。

### 數據庫設計

在 `project.db` 中定義了 `chat_history` 資料表：

```sql
CREATE TABLE IF NOT EXISTS chat_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,      -- 例如: 'aiide_control_center'
    role TEXT NOT NULL,            -- 'user' | 'assistant'
    content TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 讀取流程

- **Mount 階段**：當 `AiIdeControlCenter.tsx` 加載時，會發送 `get_chat_history` 請求。
- **寫入階段**：每當用戶發送或 AI 回覆時，會立即呼叫 `save_chat_message` 同步到資料庫。
- **清理階段**：點擊清除按鈕會清空對應 `session_id` 的所有欄位。

## 2. AGENT 建立與上下文轉移

TaskRails 使用「主動上下文 (Active Context)」模式來與 IDE Agent (如 Cursor) 溝通。

### 轉移流程

1. **討論**：在 TaskRails AIIDE 控制台進行規格釐清。
2. **導出**：點擊 「Transfer to IDE」，系統會執行以下動作：
   - 整合對話履歷，格式化為 Markdown。
   - 寫入 `.taskrails/memory-bank/@active_context.md`。
   - **自動複製** 載入指令到系統剪貼簿。
3. **同步**：開發者在 IDE 中貼上指令，IDE Agent 讀取文件並開始執行。

## 3. 專案文件規則 (Document Rules)

- **根目錄說明書**：優先讀取 `README.md`。
- **記憶庫路徑**：`.taskrails/memory-bank/`。
  - `@active_context.md`：目前正在進行的任務上下文。
  - `specs.md`：功能規格書。
  - `tech_stack.md`：技術棧定義。

## 4. 開發流程建議

- **新建功能**：先用「專案分析器」生成初步說明書。
- **調整規格**：在「AIIDE 控制台」討論，並轉移上下文。
- **驗收**：使用控制台生成的測試案例進行驗證。

---

_Generated by Antigravity Senior Engineer_
