# TaskRails 系統規格與架構說明書 (System Spec & Architecture)

> **版本**: v1.1
> **最後更新**: 2026-01-05

## 1. 系統概覽 (System Overview)

TaskRails 是一個結合 **AI Agent** 與 **任務管理** 的現代化開發輔助平台。它採用 **Tauri v2** 框架，結合 React 前端的靈活性與 Rust 後端的極致效能，旨在將開發流程工業化。

### 1.1 核心價值

- **結構化與流程化**：強制執行 6A (Align, Architect, Atomize, Approve, Act, Audit) 開發流程。
- **AI 協作原生**：內建 MCP (Model Context Protocol) 支援，讓 AI 能與本地環境無縫互動。
- **防劣化機制 (Anti-Degradation)**：透過角色分工 (Coder/Reviewer/Architect) 與氣閘 (Airlock) 確保代碼品質。

### 1.2 高層架構圖

```mermaid
graph TD
    User[使用者] --> UI[Frontend (React/TS)]
    UI -- IPC Commands --> Core[Rust Core (Tauri)]

    subgraph "Rust Backend"
        Core --> DB[(SQLite Database)]
        Core --> MCP_Stdio[MCP Server (Stdio)]
        Core --> MCP_SSE[MCP Server (SSE)]
        Core --> State[State Machine]
        Core --> Token[Tiktoken Middleware]
    end

    MCP_Stdio <--> IDE_A[IDE: Cursor/Trae/Antigravity]
    MCP_SSE <--> IDE_Web[Web IDEs / Remote Antigravity]
```

---

## 2. 技術堆疊 (Tech Stack)

### 2.1 前端 (Frontend)

- **核心框架**: React 19 + Vite 7 + TypeScript
- **樣式系統**: Tailwind CSS v3 + CSS Variables (Cyber-Industrial Design)
- **組件庫**: Shadcn/UI (Lucide Icons)
- **狀態管理**: React Hooks + Zustand (全域狀態)
- **可視化**: Mermaid.js (流程圖), DnD Kit (任務拖拽)

### 2.2 後端 (Backend)

- **運行時**: Rust (Tauri v2)
- **資料庫**: SQLite (本地數據持久化，使用 `rusqlite` 與 `deadpool` 連接池)
- **通訊協議**:
  - **Tauri Invoke**: 前後端指令溝通
  - **MCP Server (Stdio/SSE)**: 作為 Agent 接口
  - **Satellite Server (Actix)**: 提供外部 API 訪問能力

---

## 3. 核心功能與模組 (Core Modules)

### 3.1 雙模 MCP 引擎 (Dual-Mode MCP Engine)

TaskRails 支援兩種傳輸層，確保與各類 AI IDE 的相容性：

- **Stdio Channel**: 針對本機進程通訊 (如 Cursor, Antigravity)。
- **SSE Channel (Server-Sent Events)**: 針對遠端或 Web 環境，預設運行於 `localhost:4567`。

### 3.2 狀態機與 Token 監控

- **狀態管理**: 追蹤 `Idle`, `CoderWorking`, `ReviewerWorking`, `AirlockWait` 等狀態，限制 AI 的行為（如 Reviewer 模式為唯讀）。
- **Token Monitor**: 使用 `tiktoken-rs` 實時監測對話量，並在接近閾值時發出警告。

### 3.3 專案與任務管理

- **Project Setup Hub**: 一鍵初始化專案，自動生成 `.taskrails` 配置、Spec 說明書及 Agent 角色。
- **Planner & Kanban**: 視覺化任務看板，支援 Phase 與 Priority 排序。
- **Memory & Experience**:
  - **Memory Bank**: 儲存技術規格與規則。
  - **Experience Library**: 紀錄 Debug 經驗與解決方案。

---

## 4. 目錄結構 (Directory Structure)

```text
taskrails/
├── src/                # 前端原始碼 (React)
│   ├── components/     # features/ (業務組件), layout/, ui/
│   ├── hooks/          # 自定義 Hooks
│   ├── store/          # 狀態管理
│   └── main.tsx        # 入口
├── src-tauri/          # 後端原始碼 (Rust)
│   ├── src/
│   │   ├── commands/   # 前端呼叫的 API
│   │   ├── mcp/        # MCP Server 實作
│   │   ├── db/         # SQLite 操作
│   │   └── lib.rs      # 後端入口
├── docs/               # 專案文檔
├── public/             # 靜態資源
└── .taskrails/         # 專案本地配置 (JSON & Memory Bank)
```

---

## 5. 核心 API 指令 (Rust Commands)

前端透過 `invoke` 調用的主要指令：

- **Task**: `create_task`, `update_task`, `get_tasks`
- **System**: `open_chat_window`, `check_environment`
- **File**: `read_workspace_file`, `write_workspace_file`, `pick_folder`
- **AI**: `execute_ai_chat`, `get_chat_history`, `save_chat_message`

---

_© 2026 TaskRails. MIT License. Generated by Antigravity Agent._
